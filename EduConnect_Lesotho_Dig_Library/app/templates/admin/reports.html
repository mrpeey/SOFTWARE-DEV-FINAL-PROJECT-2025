{% extends "base.html" %}

{% block title %}Reports & Analytics - Admin - {{ library_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 mb-2">
                        <i class="fas fa-chart-bar me-2"></i>Reports & Analytics
                    </h1>
                    <p class="text-muted">Library statistics and reports</p>
                </div>
                <div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="exportReport()">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="refreshReports()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 class="card-title">{{ total_books or 0 }}</h3>
                            <p class="card-text">Total Books</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-book fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 class="card-title">{{ total_users or 0 }}</h3>
                            <p class="card-text">Total Users</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 class="card-title">{{ active_borrowings or 0 }}</h3>
                            <p class="card-text">Active Borrowings</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-book-reader fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 class="card-title">{{ overdue_books or 0 }}</h3>
                            <p class="card-text">Overdue Books</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Monthly Borrowings</h5>
                </div>
                <div class="card-body">
                    <canvas id="borrowingsChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Popular Categories</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoriesChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Reports -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Most Popular Books</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="timeframe" id="week" checked>
                        <label class="btn btn-outline-secondary" for="week">Week</label>
                        
                        <input type="radio" class="btn-check" name="timeframe" id="month">
                        <label class="btn btn-outline-secondary" for="month">Month</label>
                        
                        <input type="radio" class="btn-check" name="timeframe" id="year">
                        <label class="btn btn-outline-secondary" for="year">Year</label>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Rank</th>
                                    <th>Book Title</th>
                                    <th>Author</th>
                                    <th>Borrowings</th>
                                    <th>Rating</th>
                                </tr>
                            </thead>
                            <tbody id="popularBooksTable">
                                {% if popular_books %}
                                {% for book in popular_books %}
                                <tr>
                                    <td><span class="badge bg-primary">#{{ loop.index }}</span></td>
                                    <td>{{ book.title }}</td>
                                    <td>{{ book.author }}</td>
                                    <td>{{ book.borrowing_count or 0 }}</td>
                                    <td>
                                        {% if book.average_rating %}
                                        <span class="text-warning">
                                            {% for i in range(5) %}
                                                {% if i < book.average_rating %}
                                                    <i class="fas fa-star"></i>
                                                {% else %}
                                                    <i class="far fa-star"></i>
                                                {% endif %}
                                            {% endfor %}
                                            ({{ "%.1f"|format(book.average_rating) }})
                                        </span>
                                        {% else %}
                                        <span class="text-muted">No ratings</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        No borrowing data available
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">System Status</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Storage Usage</span>
                            <span>{{ storage_usage or 0 }}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: {{ storage_usage or 0 }}%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Active Users Today</span>
                            <span class="badge bg-success">{{ daily_active_users or 0 }}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>New Registrations</span>
                            <span class="badge bg-info">{{ new_registrations or 0 }}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Books Added Today</span>
                            <span class="badge bg-primary">{{ books_added_today or 0 }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% if recent_activities %}
                        {% for activity in recent_activities %}
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    {% if activity.type == 'borrowing' %}
                                    <i class="fas fa-book-reader text-primary"></i>
                                    {% elif activity.type == 'return' %}
                                    <i class="fas fa-undo text-success"></i>
                                    {% elif activity.type == 'registration' %}
                                    <i class="fas fa-user-plus text-info"></i>
                                    {% else %}
                                    <i class="fas fa-circle text-secondary"></i>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <small class="text-muted">{{ activity.timestamp.strftime('%H:%M') if activity.timestamp else 'Unknown' }}</small>
                                    <br>
                                    <span class="small">{{ activity.description }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <br>
                            No recent activity
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    initBorrowingsChart();
    initCategoriesChart();
});

function initBorrowingsChart() {
    const ctx = document.getElementById('borrowingsChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ borrowings_chart_labels | safe if borrowings_chart_labels else "['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun']" }},
            datasets: [{
                label: 'Borrowings',
                data: {{ borrowings_chart_data | safe if borrowings_chart_data else "[12, 19, 3, 5, 2, 3]" }},
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function initCategoriesChart() {
    const ctx = document.getElementById('categoriesChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: {{ categories_chart_labels | safe if categories_chart_labels else "['Fiction', 'Non-fiction', 'Science', 'History']" }},
            datasets: [{
                data: {{ categories_chart_data | safe if categories_chart_data else "[30, 25, 20, 25]" }},
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true
        }
    });
}

function refreshReports() {
    window.location.reload();
}

function exportReport() {
    const format = prompt('Export format (pdf/csv):', 'pdf');
    if (format && ['pdf', 'csv'].includes(format.toLowerCase())) {
        window.open(`/admin/reports/export?format=${format}`, '_blank');
    }
}

// Handle timeframe changes for popular books
document.querySelectorAll('input[name="timeframe"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const timeframe = this.id;
        fetch(`/admin/reports/popular-books?timeframe=${timeframe}`)
            .then(response => response.json())
            .then(data => {
                updatePopularBooksTable(data.books);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    });
});

function updatePopularBooksTable(books) {
    const tbody = document.getElementById('popularBooksTable');
    if (books && books.length > 0) {
        tbody.innerHTML = books.map((book, index) => `
            <tr>
                <td><span class="badge bg-primary">#${index + 1}</span></td>
                <td>${book.title}</td>
                <td>${book.author}</td>
                <td>${book.borrowing_count || 0}</td>
                <td>
                    ${book.average_rating ? 
                        `<span class="text-warning">
                            ${'★'.repeat(Math.floor(book.average_rating))}${'☆'.repeat(5 - Math.floor(book.average_rating))}
                            (${book.average_rating.toFixed(1)})
                        </span>` : 
                        '<span class="text-muted">No ratings</span>'
                    }
                </td>
            </tr>
        `).join('');
    } else {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    No borrowing data available
                </td>
            </tr>
        `;
    }
}
</script>
{% endblock %}