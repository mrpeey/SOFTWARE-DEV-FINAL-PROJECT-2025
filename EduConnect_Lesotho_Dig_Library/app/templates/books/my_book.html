{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow-lg mb-4">
    <div class="row g-0">
      <div class="col-md-4 text-center p-4">
        {% if book.cover_image %}
          <img src="{{ url_for('static', filename='uploads/covers/' + book.cover_image) }}" class="w-100 shadow rounded" alt="Book Cover" style="border-radius:16px; max-width:100%; height:340px; object-fit:cover;">
        {% else %}
          {% set category_colors = {
            'Academic': ['#3b82f6', '#60a5fa'],
            'Literature': ['#a855f7', '#f472b6'],
            'Science': ['#14b8a6', '#06b6d4'],
            'Technology': ['#0ea5e9', '#6366f1'],
            'History': ['#f59e42', '#fbbf24'],
            'Culture': ['#f43f5e', '#fb7185'],
            'Health': ['#22c55e', '#4ade80'],
            'Medicine': ['#eab308', '#fde68a'],
            'Agriculture': ['#84cc16', '#a3e635'],
            'Business': ['#f97316', '#fbbf24'],
            'Economics': ['#e11d48', '#f472b6'],
            'Government': ['#6366f1', '#818cf8'],
            'Law': ['#f43f5e', '#e11d48'],
            'Digital': ['#0ea5e9', '#38bdf8'],
            'Literacy': ['#a855f7', '#6366f1'],
            'Local': ['#f59e42', '#fbbf24']
          } %}
          {% set cat_colors = category_colors.get(book.category.name.split(' ')[0] if book.category else '', ['#764ba2', '#a855f7']) %}
          {% set title_length = book.title|length %}
          {% set author_length = book.author|length %}
          {% set svg_height = 340 %}
          {% set svg_width = 340 %}
          <svg width="100%" height="{{ svg_height }}" viewBox="0 0 {{ svg_width }} {{ svg_height }}" xmlns="http://www.w3.org/2000/svg" style="background: #f8f9fa; border-radius: 16px;">
            <defs>
              <linearGradient id="gradBook" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="{{ cat_colors[0] }}" />
                <stop offset="100%" stop-color="{{ cat_colors[1] }}" />
              </linearGradient>
            </defs>
            <rect width="{{ svg_width }}" height="{{ svg_height }}" rx="32" fill="url(#gradBook)"/>
            <!-- Set SVG background color to match the first gradient color -->
            <style>
              svg { background: {{ cat_colors[0] }} !important; }
            </style>
            {% set dynamic_title_font = 28 if title_length <= 30 else 22 if title_length <= 40 else 18 %}
            {% set dynamic_author_font = 22 if author_length <= 24 else 18 %}
            <text x="50%" y="38%" text-anchor="middle" fill="#fff" font-size="{{ dynamic_title_font }}" font-weight="bold" font-family="Arial, sans-serif">{{ book.title|truncate(60, True, '...') }}</text>
            <text x="50%" y="60%" text-anchor="middle" fill="#e0e0e0" font-size="{{ dynamic_author_font }}" font-family="Arial, sans-serif">{{ book.author|truncate(40, True, '...') }}</text>
            <g>
              <circle cx="200" cy="40" r="22" fill="#fff" opacity="0.15" />
              <text x="{{ svg_width - 40 }}" y="50" text-anchor="middle" fill="#fff" font-size="22" font-family="Arial">&#128214;</text>
            </g>
          </svg>
        {% endif %}
      </div>
      <div class="col-md-8">
        <div class="card-body">
          <h3 class="card-title">{{ book.title }}</h3>
          <h5 class="card-subtitle mb-2 text-muted">by {{ book.author }}</h5>
          <p class="mb-1"><strong>Category:</strong> {{ book.category or 'N/A' }}</p>
          <p class="mb-1"><strong>Year:</strong> {{ book.publication_year or 'N/A' }} | <strong>Edition:</strong> {{ book.edition or 'N/A' }}</p>
          <p class="mb-1"><strong>Pages:</strong> {{ book.pages or 'N/A' }} | <strong>Language:</strong> {{ book.language }}</p>
          <p class="mt-3">{{ book.description }}</p>
          <div class="d-flex align-items-center mb-2">
            <span class="me-2"><strong>Average Rating:</strong></span>
            <span class="text-warning">{% for i in range(1, 6) %}<i class="fa fa-star{% if i > book.average_rating %}-o{% endif %}"></i>{% endfor %}</span>
            <span class="ms-2">({{ book.average_rating }}/5, {{ book.review_count }} reviews)</span>
          </div>
          <div class="mt-3">
            {% if can_borrow %}
                 <a href="{{ url_for('books.borrow_book', book_id=book.id) }}" class="btn btn-primary me-2">Book</a>
            {% else %}
              <button class="btn btn-secondary me-2" disabled title="{{ borrow_msg }}">Book</button>
            {% endif %}
            <button class="btn btn-outline-info me-2" onclick="shareBook()">Share</button>
            {% if book.is_digital and can_download %}
              <a href="{{ url_for('books.download_book', book_id=book.id) }}" class="btn btn-success">Download</a>
            {% elif book.is_digital %}
              <button class="btn btn-secondary" disabled title="{{ download_msg }}">Download</button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h4 class="mb-0">Reviews</h4>
    </div>
    <div class="card-body">
      {# Show add/edit/delete review options for current user #}
      {% set user_review = None %}
      {% if reviews and current_user.is_authenticated %}
        {% for review in reviews %}
          {% if review.user and review.user.id == current_user.id %}
            {% set user_review = review %}
          {% endif %}
        {% endfor %}
      {% endif %}
      <div class="mb-3">
        {% if current_user.is_authenticated %}
          {% if user_review %}
            <a href="{{ url_for('books.edit_review', book_id=book.id, review_id=user_review.id) }}" class="btn btn-warning btn-sm me-2">Edit Your Review</a>
            <form action="{{ url_for('books.delete_review', book_id=book.id, review_id=user_review.id) }}" method="post" style="display:inline;">
              <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete your review?');">Delete Your Review</button>
            </form>
          {% else %}
            <a href="{{ url_for('books.review_book', book_id=book.id) }}" class="btn btn-primary btn-sm">Add Your Review</a>
          {% endif %}
        {% endif %}
      </div>
      {% if reviews %}
        {% for review in reviews %}
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <img src="{{ url_for('static', filename='uploads/profiles/' ~ review.user.profile_image) if review.user and review.user.profile_image else url_for('static', filename='images/default_profile.png') }}" class="rounded-circle me-2" width="40" height="40" alt="Reviewer">
                <span class="fw-bold">{{ review.user.get_full_name() if review.user else 'Anonymous' }}</span>
                <span class="ms-3 text-warning">{% for i in range(1, 6) %}<i class="fa fa-star{% if i > review.rating %}-o{% endif %}"></i>{% endfor %}</span>
                <span class="ms-3 text-muted small">{{ review.created_at.strftime('%Y-%m-%d') if review.created_at else '' }}</span>
              </div>
              <p class="mb-0">{{ review.review_text }}</p>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="text-muted">No reviews yet for this book.</p>
      {% endif %}
    </div>
  </div>
</div>
<script>
function shareBook() {
  const url = window.location.href;
  navigator.clipboard.writeText(url);
  alert('Book link copied to clipboard!');
}
</script>
{% endblock %}
