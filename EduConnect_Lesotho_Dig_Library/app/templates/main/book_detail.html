<script>
window.currentUserId = "{{ current_user.id if current_user.is_authenticated else '' }}";
</script>
{% extends "base.html" %}
{% block title %}{{ book.title }} - {{ library_name }}{% endblock %}

{% block content %}
<!-- Back to Top Button -->
<a href="#" id="backToTopBtn" class="btn btn-primary btn-lg position-fixed" style="bottom:32px; right:32px; z-index:9999; border-radius:50%; display:none;" title="Back to Top">
    <i class="fas fa-arrow-up"></i>
</a>


{% block extra_css %}
<style>
    .text-purple {
        color: #6f42c1 !important;
    }
</style>
{% endblock %}

<!-- Enhanced Book Actions -->
<div class="row justify-content-center mt-4">
    <div class="col-lg-10 col-md-12">
        <div class="card border-0 shadow mb-4">
            <div class="card-header bg-gradient-primary text-white d-flex flex-column flex-md-row justify-content-between align-items-center" style="background: linear-gradient(90deg, #6c63ff 0%, #48c6ef 100%);">
                <h3 class="mb-2 mb-md-0"><i class="fas fa-book-open me-2"></i> {{ book.title }}</h3>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-warning" id="favorite-btn" title="Favorite"><i class="fas fa-heart"></i></button>
                    <button class="btn btn-outline-info" id="download-btn" title="Download"><i class="fas fa-download"></i></button>
                    <button class="btn btn-outline-secondary" id="share-btn" title="Share"><i class="fas fa-share-alt"></i></button>
                    <button class="btn btn-outline-success" id="borrow-btn" title="Borrow"><i class="fas fa-book-reader"></i></button>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-4 align-items-center">
                    <div class="col-md-4 text-center">
                        {% if book.cover_image %}
                            <img src="{{ url_for('static', filename=book.cover_image) }}" class="img-fluid rounded shadow" alt="{{ book.title }}" style="width:100%;max-width:500px;height:auto;max-height:400px;object-fit:contain;">
                        {% elif book.svg_placeholder %}
                            <img src="{{ url_for('static', filename=book.svg_placeholder) }}" class="img-fluid rounded shadow" alt="{{ book.title }} SVG" style="width:100%;max-width:500px;height:auto;max-height:400px;object-fit:contain;">
                        {% else %}
                            <img src="{{ url_for('static', filename='images/default-cover.png') }}" class="img-fluid rounded shadow" alt="{{ book.title }}" style="width:100%;max-width:500px;height:auto;max-height:400px;object-fit:contain;">
                        {% endif %}
                        <div class="mt-2">
                            <span class="badge bg-primary">{{ book.category }}</span>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h5 class="text-purple">Author: {{ book.author }}</h5>
                        <p class="mb-2">{{ book.description }}</p>
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            <span class="badge bg-info">Published: {{ book.published_date }}</span>
                            <span class="badge bg-success">Pages: {{ book.page_count }}</span>
                            <span class="badge bg-warning text-dark">Language: {{ book.language }}</span>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            {% if book.tags %}
                                {% for tag in book.tags.split(',') %}
                                    <span class="badge bg-light text-dark border">{{ tag.strip() }}</span>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Review Section -->
<div class="row justify-content-center mt-4">
    <div class="col-lg-10 col-md-12">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white d-flex flex-column flex-md-row justify-content-between align-items-center">
                <h4 class="mb-2 mb-md-0"><i class="fas fa-comments me-2 text-primary"></i> Reviews</h4>
                <button class="btn btn-success" id="add-review-btn"><i class="fas fa-pen"></i> Write a Review</button>
            </div>
            <div class="card-body" id="reviews-list">
                <!-- Reviews will be loaded here by JS -->
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="review-form">
                <div class="modal-header">
                    <h5 class="modal-title" id="reviewModalLabel">
                      {% if review_id is defined and review_id %}Edit Your Review{% else %}Write a Review{% endif %}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="review_id" id="review_id">
                    <div class="mb-3">
                        <label for="rating" class="form-label">Your Rating</label>
                        <div id="star-rating" class="mb-2">
                            {% for i in range(1, 6) %}
                            <span class="star" data-value="{{ i }}" style="font-size:1.5rem;cursor:pointer;color:#ffc107;">&#9733;</span>
                            {% endfor %}
                        </div>
                        <select class="form-select visually-hidden" id="rating" name="rating" required>
                            <option value="">Select rating</option>
                            {% for i in range(1, 6) %}
                            <option value="{{ i }}">{{ i }} Star{% if i > 1 %}s{% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="review_text" class="form-label">Your Review</label>
                        <textarea class="form-control" id="review_text" name="review_text" rows="4" required placeholder="Share your thoughts about this book..."></textarea>
                    </div>
                    <div id="review-status" class="mb-2 text-info" style="display:none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">{% if review_id is defined and review_id %}Update Review{% else %}Submit Review{% endif %}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Example AJAX logic for reviews (requires backend API endpoints)
document.addEventListener('DOMContentLoaded', function() {
    // Load reviews
    function loadReviews() {
        fetch(`/api/books/{{ book.id }}/reviews`)
            .then(res => res.json())
            .then(function(data) {
                const reviewsList = document.getElementById('reviews-list');
                reviewsList.innerHTML = '';
                if (data.reviews && data.reviews.length) {
                    data.reviews.forEach(function(review) {
                        const isOwnReview = window.currentUserId && window.currentUserId == review.user_id;
                        const profileImgSrc = review.profile_image ? `/static/uploads/profiles/${review.profile_image}` : '/static/images/default-profile.png';
                        reviewsList.innerHTML += `
                            <div class="border-bottom py-3">
                                <div class="d-flex align-items-center mb-1">
                                    <img src="${profileImgSrc}" alt="Profile" class="rounded-circle me-2" style="width:40px;height:40px;object-fit:cover;border:1px solid #ccc;">
                                    <div class="flex-grow-1">
                                        <strong>${review.user_name || 'Anonymous'}</strong>
                                        <span class="text-warning ms-2">${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}</span>
                                        <small class="text-muted ms-2">${review.created_at}</small>
                                        ${review.is_approved ? '' : '<span class="badge bg-warning ms-2">Pending Approval</span>'}
                                    </div>
                                </div>
                                <div class="mb-2 ms-5">${review.review_text}</div>
                                <div class="d-flex gap-2 ms-5">
                                    <button class='btn btn-sm btn-outline-info me-2' onclick="editReview(${review.id}, ${review.rating}, '${review.review_text.replace(/'/g, "&#39;").replace(/\"/g, '&quot;').replace(/\n/g, ' ')}', ${review.is_approved})" ${isOwnReview ? '' : 'disabled'}>Edit</button>
                                    <button class='btn btn-sm btn-outline-danger' onclick='deleteReview(${review.id})' ${isOwnReview ? '' : 'disabled'}>Delete</button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    reviewsList.innerHTML = '<p class="text-muted text-center">No reviews yet. Be the first to review this book!</p>';
                }
            });
    }
    loadReviews();

    // Add/Edit Review
    document.getElementById('add-review-btn').onclick = function() {
        document.getElementById('review_id').value = '';
        document.getElementById('rating').value = '';
        document.getElementById('review_text').value = '';
        new bootstrap.Modal(document.getElementById('reviewModal')).show();
    };
    window.editReview = function(id, rating, text, isApproved) {
        document.getElementById('review_id').value = id;
        document.getElementById('rating').value = rating;
        document.getElementById('review_text').value = text;
        document.getElementById('review-status').style.display = isApproved ? 'none' : 'block';
        document.getElementById('review-status').textContent = isApproved ? '' : 'Your review is pending approval.';
        new bootstrap.Modal(document.getElementById('reviewModal')).show();
    };
    // Star rating UX logic
    document.querySelectorAll('#star-rating .star').forEach(function(star) {
        star.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            document.getElementById('rating').value = value;
            document.querySelectorAll('#star-rating .star').forEach(function(s, idx) {
                s.style.color = idx < value ? '#ffc107' : '#e4e5e9';
            });
        });
    });
    document.getElementById('review-form').onsubmit = function(e) {
        e.preventDefault();
        const id = document.getElementById('review_id').value;
        const rating = parseInt(document.getElementById('rating').value, 10);
        const text = document.getElementById('review_text').value;
        fetch(`/api/books/{{ book.id }}/reviews${id ? '/' + id : ''}`, {
            method: id ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
            body: JSON.stringify({ rating, review_text: text })
        })
        .then(function(res) { return res.json(); })
        .then(function() {
            bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
            loadReviews();
        });
    };
    window.deleteReview = function(id) {
        if (confirm('Delete this review?')) {
            fetch(`/api/books/{{ book.id }}/reviews/${id}`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
            })
            .then(function() { loadReviews(); });
        }
    };

    // Favorite, Download, Share, Borrow (placeholders)
    document.getElementById('favorite-btn').onclick = function() {
        fetch(`/api/books/{{ book.id }}/favorite`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token() }}' } })
            .then(function() { alert('Book marked as favorite!'); });
    };
    document.getElementById('download-btn').onclick = function() {
        fetch(`/api/books/{{ book.id }}/download`, { method: 'GET', headers: { 'X-CSRFToken': '{{ csrf_token() }}' } })
            .then(function() { alert('Download started!'); });
    };
    document.getElementById('share-btn').onclick = function() {
        if (navigator.share) {
            navigator.share({ title: '{{ book.title }}', url: window.location.href });
        } else {
            alert('Share link copied!');
        }
    };
    document.getElementById('borrow-btn').onclick = function() {
        fetch(`/api/books/{{ book.id }}/borrow`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token() }}' } })
            .then(function() { alert('Book borrowed!'); });
    };
});
</script>
{% endblock %}

