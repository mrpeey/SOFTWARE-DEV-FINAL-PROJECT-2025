<script>
window.currentUserId = "{{ current_user.id if current_user.is_authenticated else '' }}";
</script>

{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="mb-3 w-100 d-flex justify-content-end gap-2">
        <a href="{{ url_for('main.index') }}" class="btn btn-light">
            <i class="fas fa-home me-1"></i>Back to Home
        </a>
    </div>
    <div class="mb-3 d-flex gap-2">
        <a href="{{ url_for('books.my_books') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-1"></i> Back to My Books
        </a>
    </div>
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Recommended Reading</h3>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for rec in book.recommended_reading if book.recommended_reading %}
                            <li class="list-group-item">
                                <a href="{{ url_for('main.book_detail', book_id=rec.id) }}">{{ rec.title }} by {{ rec.author }}</a>
                            </li>
                        {% else %}
                            <li class="list-group-item text-muted">No recommended reading for this book.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="card shadow-lg mb-4">
        <div class="row g-0">
            <div class="col-md-4 text-center p-4">
                {% if book.cover_image %}
                    <img src="{{ url_for('static', filename='uploads/covers/' + book.cover_image) }}" class="w-100 shadow rounded" alt="Book Cover" style="border-radius:16px; max-width:100%; height:340px; object-fit:cover;">
                {% else %}
                    {% include 'shared/book_cover_svg.html' %}
                    {% set svg_height = 340 %}
                    {% set svg_width = 340 %}
                    <svg width="100%" height="{{ svg_height }}" viewBox="0 0 {{ svg_width }} {{ svg_height }}" xmlns="http://www.w3.org/2000/svg" style="background: #f8f9fa; border-radius: 16px;">
                        <defs>
                            <linearGradient id="gradBook" x1="0" y1="0" x2="1" y2="1">
                                <stop offset="0%" stop-color="{{ cat_colors[0] }}" />
                                <stop offset="100%" stop-color="{{ cat_colors[1] }}" />
                            </linearGradient>
                        </defs>
                        <rect width="{{ svg_width }}" height="{{ svg_height }}" rx="32" fill="url(#gradBook)"/>
                        {% set dynamic_title_font = 28 if title_length <= 30 else 22 if title_length <= 40 else 18 %}
                        {% set dynamic_author_font = 22 if author_length <= 24 else 18 %}
                        <text x="50%" y="38%" text-anchor="middle" fill="#fff" font-size="{{ dynamic_title_font }}" font-weight="bold" font-family="Arial, sans-serif">{{ book.title|truncate(60, True, '...') }}</text>
                        <text x="50%" y="60%" text-anchor="middle" fill="#e0e0e0" font-size="{{ dynamic_author_font }}" font-family="Arial, sans-serif">{{ book.author|truncate(40, True, '...') }}</text>
                        <g>
                            <circle cx="200" cy="40" r="22" fill="#fff" opacity="0.15" />
                            <text x="{{ svg_width - 40 }}" y="50" text-anchor="middle" fill="#fff" font-size="22" font-family="Arial">&#128214;</text>
                        </g>
                    </svg>
                {% endif %}
            </div>
            <div class="col-md-8">
                <div class="card-body">
                    <h3 class="card-title">{{ book.title }}</h3>
                    <h5 class="card-subtitle mb-2 text-muted">by {{ book.author }}</h5>
                    <p class="mb-1"><strong>Category:</strong> {{ book.category or 'N/A' }}</p>
                    <p class="mb-1"><strong>Year:</strong> {{ book.publication_year or 'N/A' }} | <strong>Edition:</strong> {{ book.edition or 'N/A' }}</p>
                    <p class="mb-1"><strong>Pages:</strong> {{ book.pages or 'N/A' }} | <strong>Language:</strong> {{ book.language }}</p>
                    <p class="mt-3">{{ book.description }}</p>
                    <div class="d-flex align-items-center mb-2">
                        <span class="me-2"><strong>Average Rating:</strong></span>
                        <span class="text-warning">{% for i in range(1, 6) %}<i class="fa fa-star{% if i > book.average_rating %}-o{% endif %}"></i>{% endfor %}</span>
                        <span class="ms-2">({{ book.average_rating }}/5, {{ book.review_count }} reviews)</span>
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('main.index') }}" class="btn btn-secondary me-2">Home</a>
                        <a href="{{ url_for('books.my_books') }}" class="btn btn-primary me-2">My Books</a>
                        {% if can_borrow %}
                                 <a href="{{ url_for('books.borrow_confirm', book_id=book.id) }}" class="btn btn-success me-2">Borrow</a>
                        {% else %}
                            <button class="btn btn-secondary me-2" disabled title="{{ borrow_msg }}">Borrow</button>
                        {% endif %}
                        <div class="dropdown d-inline me-2">
                            <button class="btn btn-info dropdown-toggle" type="button" id="shareDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-share-alt me-1"></i>Share
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="shareDropdown">
                                <li><a id="shareEmail" class="dropdown-item" target="_blank"><i class="fas fa-envelope me-1"></i>Email</a></li>
                                <li><a id="shareWhatsApp" class="dropdown-item" target="_blank"><i class="fab fa-whatsapp me-1"></i>WhatsApp</a></li>
                                <li><a id="shareFacebook" class="dropdown-item" target="_blank"><i class="fab fa-facebook me-1"></i>Facebook</a></li>
                                <li><button id="shareCopy" class="dropdown-item"><i class="fas fa-link me-1"></i>Copy Link</button></li>
                                <li><button id="shareNative" class="dropdown-item"><i class="fas fa-share-alt me-1"></i>Share via Device...</button></li>
                            </ul>
                        </div>
                        <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            var bookUrl = window.location.href;
                            var bookTitle = document.querySelector('h3.card-title, h2').innerText;
                            document.getElementById('shareEmail').href = `mailto:?subject=Check out this book: ${bookTitle}&body=View it here: ${bookUrl}`;
                            document.getElementById('shareWhatsApp').href = `https://wa.me/?text=Check out this book: ${bookTitle} - ${bookUrl}`;
                            document.getElementById('shareFacebook').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(bookUrl)}`;
                            document.getElementById('shareCopy').onclick = function() {
                                navigator.clipboard.writeText(bookUrl);
                                this.blur();
                                alert('Book link copied to clipboard!');
                            };
                            document.getElementById('shareNative').onclick = function() {
                                if (navigator.share) {
                                    navigator.share({
                                        title: bookTitle,
                                        text: `Check out this book: ${bookTitle}`,
                                        url: bookUrl
                                    });
                                } else {
                                    alert('Native sharing is not supported on this device/browser. Please use another option.');
                                }
                            };
                        });
                        </script>
                        {% if book.is_digital and can_download %}
                            <a href="{{ url_for('books.download_book', book_id=book.id) }}" class="btn btn-success">Download</a>
                        {% elif book.is_digital %}
                            <button class="btn btn-secondary" disabled title="{{ download_msg }}">Download</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h4 class="mb-0">Reviews</h4>
        </div>
        <div class="card-body">
            {% set user_review = None %}
            {% if reviews and current_user.is_authenticated %}
                {% for review in reviews %}
                    {% if review.user and review.user.id == current_user.id %}
                        {% set user_review = review %}
                    {% endif %}
                {% endfor %}
            {% endif %}
            <div class="mb-3">
                {% if current_user.is_authenticated %}
                    <div id="reviewActions">
                        {% if user_review %}
                            <button class="btn btn-warning btn-sm me-2" id="editReviewBtn">Edit Your Review</button>
                            <button class="btn btn-danger btn-sm" id="deleteReviewBtn">Delete Your Review</button>
                        {% else %}
                            <button class="btn btn-primary btn-sm" id="writeReviewBtn">Write a Review</button>
                        {% endif %}
                    </div>
                    <form id="ajaxReviewForm" style="display:none;" autocomplete="off">
                        <div class="mb-2">
                            <textarea name="review_text" id="reviewText" class="form-control" rows="3">{% if user_review %}{{ user_review.review_text }}{% endif %}</textarea>
                        </div>
                        <div class="mb-2">
                            <label for="rating" class="form-label">Rating:</label>
                            <select name="rating" id="reviewRating" class="form-select" style="width:auto; display:inline-block;">
                                {% for i in range(1, 6) %}
                                    <option value="{{ i }}" {% if user_review and user_review.rating == i %}selected{% endif %}>{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success btn-sm me-2">Save</button>
                        <button type="button" class="btn btn-secondary btn-sm" id="cancelReviewBtn">Cancel</button>
                    </form>
                {% endif %}
            </div>
            {% if reviews %}
                {% for review in reviews %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <img src="{{ url_for('static', filename='uploads/profiles/' ~ review.user.profile_image) if review.user and review.user.profile_image else url_for('static', filename='images/default_profile.png') }}" class="rounded-circle me-2" width="40" height="40" alt="Reviewer">
                                <span class="fw-bold">{{ review.user.get_full_name() if review.user else 'Anonymous' }}</span>
                                <span class="ms-3 text-warning">{% for i in range(1, 6) %}<i class="fa fa-star{% if i > review.rating %}-o{% endif %}"></i>{% endfor %}</span>
                                <span class="ms-3 text-muted small">{{ review.created_at.strftime('%Y-%m-%d') if review.created_at else '' }}</span>
                                {% if review.is_approved %}
                                    <span class="badge bg-success ms-2">Approved</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark ms-2">Pending</span>
                                {% endif %}
                            </div>
                            {% if current_user.is_authenticated and review.user and review.user.id == current_user.id %}
                                <div id="userReviewDisplay">
                                    <p class="mb-0">{{ review.review_text }}</p>
                                </div>
                                <form id="editReviewForm" action="{{ url_for('books.edit_review', book_id=book.id, review_id=review.id) }}" method="post" style="display:none;">
                                    <div class="mb-2">
                                        <textarea name="review_text" class="form-control" rows="3">{{ review.review_text }}</textarea>
                                    </div>
                                    <div class="mb-2">
                                        <label for="rating" class="form-label">Rating:</label>
                                        <select name="rating" class="form-select" style="width:auto; display:inline-block;">
                                            {% for i in range(1, 6) %}
                                                <option value="{{ i }}" {% if review.rating == i %}selected{% endif %}>{{ i }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-success btn-sm me-2">Save</button>
                                    <button type="button" class="btn btn-secondary btn-sm" id="cancelEditBtn">Cancel</button>
                                </form>
                            {% else %}
                                <p class="mb-0">{{ review.review_text }}</p>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No reviews yet for this book.</p>
            {% endif %}
        </div>
    </div>
</div>
<script>
function shareBook() {
    const url = window.location.href;
    navigator.clipboard.writeText(url);
    alert('Book link copied to clipboard!');
}
document.addEventListener('DOMContentLoaded', function() {
    const reviewActions = document.getElementById('reviewActions');
    const ajaxReviewForm = document.getElementById('ajaxReviewForm');
    const writeBtn = document.getElementById('writeReviewBtn');
    const editBtn = document.getElementById('editReviewBtn');
    const deleteBtn = document.getElementById('deleteReviewBtn');
    const cancelBtn = document.getElementById('cancelReviewBtn');
    const reviewText = document.getElementById('reviewText');
    const reviewRating = document.getElementById('reviewRating');
    const bookId = {{ book.id }};
    const userReviewId = {{ user_review.id if user_review else 'null' }};

    function showForm(isEdit) {
        ajaxReviewForm.style.display = 'block';
        reviewActions.style.display = 'none';
        if (!isEdit) {
            reviewText.value = '';
            reviewRating.value = '5';
        }
    }
    function hideForm() {
        ajaxReviewForm.style.display = 'none';
        reviewActions.style.display = 'block';
    }
    if (writeBtn) writeBtn.onclick = () => showForm(false);
    if (editBtn) editBtn.onclick = () => showForm(true);
    if (cancelBtn) cancelBtn.onclick = hideForm;
    if (ajaxReviewForm) {
        ajaxReviewForm.onsubmit = function(e) {
            e.preventDefault();
            const text = reviewText.value.trim();
            const rating = reviewRating.value;
            if (!text || text.length < 10) {
                alert('Review must be at least 10 characters.');
                return;
            }
            const url = userReviewId ? `/books/api/review/${bookId}/${userReviewId}` : `/books/api/review/${bookId}`;
            const method = userReviewId ? 'PUT' : 'POST';
            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rating: parseInt(rating), content: text })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Error saving review.');
                }
            });
        };
    }
    if (deleteBtn) {
        deleteBtn.onclick = function() {
            if (!confirm('Are you sure you want to delete your review?')) return;
            fetch(`/books/api/review/${bookId}/${userReviewId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Error deleting review.');
                }
            });
        };
    }
});
</script>
{% endblock %}

